#=================================================
# Description: Build V2X2 using GitHub Actions
# Lisence: MPL-2.0
# Peace and joy
#=================================================

name: Actions-V2X2

on:
  workflow_dispatch:
  #schedule:
  # - cron: 0 16 * * *

env:
  SOURCE_URL: https://github.com/XTLS/Xray-core.git
  SOURCE_BRANCH: main
  TAG: v2x2 binary
  DIY_SH: custom.sh
  BINARY_RELEASE_UPLOAD: true
  GO_VERSION: 1.20

jobs:
  Build_v2x2_binary:
    runs-on: ubuntu-latest

    outputs:
      V2X2_ROOT_PATH: ${{ steps.clone.outputs.V2X2_ROOT_PATH }}
      CURRENT_BRANCH: ${{ steps.env.outputs.CURRENT_BRANCH }}

    steps:
      - name: Checkout
        uses: actions/checkout@main

      - name: Initialization environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install curl wget git
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          docker image prune -a -f
          sudo mkdir -p /workspace

      - name: Clone Source Code
        working-directory: /workspace
        id: clone
        run: |
          df -hT $PWD
          git clone $SOURCE_URL -b $SOURCE_BRANCH workspace/v2x2
          cd workspace/v2x2
          echo "V2X2_ROOT_PATH=$PWD" >> $GITHUB_ENV
          echo "::set-output name=V2X2_ROOT_PATH::$(echo $PWD)"

      - name: Generate Variables
        id: env
        run: |
          export CURRENT_BRANCH="$(git symbolic-ref --short HEAD)"
          echo "CURRENT_BRANCH=$CURRENT_BRANCH" >> $GITHUB_ENV
          echo "::set-output name=CURRENT_BRANCH::$(echo $CURRENT_BRANCH)"

      - name: Load custom file
        run: |
          cat custom.sh >> $V2X2_ROOT_PATH/Xray-core/core/core.go
          cd $V2X2_ROOT_PATH

      - name: Setup-GO
        uses: actions/setup-go@main
        with:
          go-version: '$GO_VERSION'
          check-latest: true

      - name: Get project dependencies
        run: go mod download
      
      - name: Build Custom V2X2
        run: |
          go build -o server.js -trimpath -ldflags "-s -w -buildid=" ./main
      
  Upload:
    needs: [Build_v2x2_binary]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@main
      
      - name: Restore Variables
        run: |
          echo "V2X2_ROOT_PATH=$(echo '${{needs.Toolchain.outputs.V2X2_ROOT_PATH}}')" >> $GITHUB_ENV
          echo "CURRENT_BRANCH=$(echo '${{needs.Toolchain.outputs.CURRENT_BRANCH}}')" >> $GITHUB_ENV

      - name: Initialization Environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install tar zip unzip
      
      - name: Download Bin Archive
        uses: actions/download-artifact@main
        with:
          name: bin-archive
          path: ${{ env.V2X2_ROOT_PATH }}
      
      - name: Decompress Bin Archive
        run: |
          cd $V2X2_ROOT_PATH
          unzip 

      - name: Decompress Bin Archive
      
      - name: Decompress Bin Archive
      
      - name: Decompress Bin Archive
      
      - name: Decompress Bin Archive
      
      - name: Decompress Bin Archive
      
      - name: Decompress Bin Archive
      
      - name: Decompress Bin Archive
